
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import root_scalar
from sklearn.metrics import r2_score
import matplotlib as mpl


mpl.rcParams['font.family'] = 'Arial'

F_data = np.array([0.0234706302182792, 0.0575482583405734, -0.0355292799825998, 0.0382706405130241, -0.0219586045278838, 0.111102461469485, -0.0656150179094611, 0.0358277644043985, -0.0389042245687256, 0.111735111033832, 0.189972385487006, 0.140244600276241, 0.0294859689582538, 0.141457948254578, 0.103462122727098, -0.0980421475296695, 0.0906831817495113, 0.151951024558986, 0.120024168789916, 0.0833589024544855, 0.0957388431341099, 0.15754506784809, 0.179151430914425, 0.139503326857282, 0.143510794490493, 0.131470522784907, 0.142452467057925, 0.027762696673248, 0.2138698144917, 0.180029441377733, 0.261911231799661, 0.204210963135141, 0.234670719472439, 0.119226844709901, 0.159071934385461, 0.170707545902833, 0.145891510208662, 0.389262180192379, 0.0870454151252024, 0.255549631130594, 0.238686609289437, 0.186562724212987, 0.130474216925246, 0.24428133612319, 0.247872393277558, 0.317260333555228, 0.295257472421208, 0.227364279111237, 0.264345970388337, 0.31843476341829, 0.38347715031166, 0.35621622126142, 0.307352271309163, 0.159472748097499, 0.131741375154804, 0.232752659806429, 0.168821727052204, 0.199719468575741, 0.290706541106834, 0.210184292872862, 0.382296686278114, 0.344965264390345, 0.279654146048385, 0.144785831933927, 0.265291087715577, 0.222805672416353, 0.226826104554464, 0.184252661356429, 0.177794081692329, 0.289113541185571, 0.304494706762192, 0.304173381033836, 0.258637149585613, 0.262772682559232, 0.347242546975975, 0.300896566398384, 0.250174798325448, 0.273498898546612, 0.319910251647347, 0.248638910404484, 0.223820862734423, 0.241324894822268, 0.301207166274492, 0.23957896013286, 0.443541292083959, 0.341304396065587, 0.507839235598104, 0.325325967099685, 0.417043246303757, 0.351949410814706, 0.292879933692041, 0.31525412825907, 0.294284465066624, 0.357908799053126, 0.288227563649177, 0.191389208364945, 0.356867303687841, 0.317286865279201, 0.272202694062517, 0.254771305725963, 0.35556797493027, 0.411163426879493, 0.309649353846162, 0.288048053227458, 0.409850457101111, 0.280159640493731, 0.271504150091324, 0.374954898399893, 0.422985015256376, 0.325068337540762, 0.333264088816753, 0.368836198571933, 0.467753380060221, 0.346797988163711, 0.336230793830484, 0.452374296746854, 0.392389147432296, 0.433746684191825, 0.406470810290113, 0.427673602622424, 0.381676941474403, 0.478078652303931, 0.437302444787516, 0.448010681266341, 0.425477508974765, 0.341543091964944, 0.400514852075217, 0.230561676050372, 0.324160920600159, 0.295092051102263, 0.204421958783042, 0.410411172816577, 0.293145228088369, 0.389550702806417, 0.403452660195068, 0.392258947113106, 0.315404831403301, 0.411738402144599, 0.407849547958078, 0.317550246101952, 0.448079666560163, 0.387660290676336, 0.347654149798894, 0.367629338117599, 0.320273480946905, 0.312830417758322, 0.413821545750191, 0.39240981894702, 0.37282846480478, 0.450603076177058, 0.312647758462547, 0.358933906918722, 0.409940505761729, 0.28463933028979, 0.381956230085562, 0.460124738892937, 0.309774324785224, 0.392085219584532, 0.468905588572108, 0.449495770749772, 0.355431211528157, 0.576954476705301, 0.3223335281236, 0.343218185774033, 0.437141144065481, 0.336346599296851, 0.469746304558328, 0.437134387692299, 0.334984590022301, 0.525106091750907, 0.541908021569592, 0.551209403676343, 0.304817522582736, 0.458617029177525, 0.610904893478698, 0.510943992029953, 0.458281540544654, 0.561685277147604, 0.550881590423984, 0.588480640248679, 0.513958557469267, 0.514902815533438, 0.629795758582037, 0.584976259718483, 0.537668932460542, 0.570370279458356, 0.562023724878636, 0.546495152635308, 0.695965888711923, 0.61640081911742, 0.535251672582931, 0.645858131750707, 0.46616125521668, 0.5727823925435, 0.557800229022023, 0.489056663998749, 0.522762343673573, 0.468316476760255, 0.480874996553985, 0.46591052260567, 0.548291834803908, 0.510265678520254, 0.707088012353105, 0.551364988278236, 0.557426714923444, 0.51631134274485, 0.685376392197048, 0.681813866442255, 0.554597730977205, 0.585692839428126, 0.546942234764058, 0.807852324767875, 0.612544855904426, 0.642168905987612, 0.746223203133282, 0.607652364885834, 0.669732337809244, 0.819807285181397, 0.769697983655285, 0.661192468368865, 0.672367943636197, 0.666581193472163, 0.709845376986433, 0.792996309498858, 0.731262865596539, 0.746669450599547, 0.812703293524231, 0.766320401535703, 0.773144493081615, 0.646380419605286, 0.825388023071869, 0.804491384939683, 0.701715455101471, 0.674422773733055, 0.779602243354783, 0.824082185704088, 0.934111791176864, 0.841132163156346, 0.821163560763954, 0.962242580870173, 0.916037201384949, 0.877985794364594, 0.842258437386883, 0.988411122986832, 0.933400410975222, 0.899797410600917, 0.93372819786982, 0.903257669993478, 1.05203034532455, 1.02758755312259, 1.00786599852597, 1.04631953363214, 0.997984598035517, 1.01678795888093, 1.08026039483796, 1.00531996516273, 1.21949173050468, 1.22331483085909, 1.13528023014985, 1.17393271540634, 1.08006736464113, 1.30090126537726, 1.32267808409522, 1.26527173962891, 1.3091803071835, 1.30051913229026, 1.18984414645373, 1.36527505950382, 1.33473086695218, 1.26856822769847, 1.47067184887933, 1.49784262208071, 1.50271721617841, 1.50408627703308, 1.37887280086651, 1.50120543155287, 1.46341723842277, 1.58983948510288, 1.62464343476393, 1.72780619288527, 1.69501397135027, 1.77351018095021, 1.86859465028661, 1.81272148943481, 1.97687327092265, 1.97454665011953, 2.03938760044696, 2.01127674776539, 2.04566829684189, 2.16851695629277, 2.2215135222929, 2.24065602847147, 2.38942056979696, 2.34469026208815, 2.36218423253936, 2.52461050308955, 2.39166404415894, 2.67388961647386, 2.7927972122818, 2.83516391046046, 2.86764244826112, 3.01793060709043, 3.04224958282333, 3.26478784678547, 3.29921546733888, 3.5049024808367, 3.6376520964808, 3.84437202325637, 3.92230599190496, 4.01169114856226, 4.29406840453019, 4.39562702921128, 4.59322613334079, 4.80717060515154, 4.99272103999221, 5.26191903679648, 5.49213292551658, 5.68611026569808, 5.81538194291961, 6.15554723011606, 6.4384160320013, 6.61304806410621, 6.89927542659224, 7.30937280656375, 7.54236521114319, 7.87575519852693, 8.46274583076832, 8.60761610578001, 9.10356930634885, 9.61458727215321, 10.0209332923289, 10.3680165609365, 10.9017827256609, 11.5531739385445, 11.9932800619035, 12.3812898616199, 12.6264115638844, 13.645419317148
])
L_data = np.array([5.03384718587756, 5.07154578620378, 5.10151991061811, 5.13923725546162, 5.17378414585588, 5.20185064794387, 5.23388897632792, 5.26731269560085, 5.29812072223893, 5.33233789229634, 5.36447759124525, 5.39951939127297, 5.43509076068911, 5.46760845609881, 5.49956310624521, 5.53097348223432, 5.56515399175906, 5.59594512733312, 5.6317896204084, 5.65554783316598, 5.6905641081108, 5.73006025529348, 5.7629537485558, 5.79418210705335, 5.82927933992756, 5.86149405533284, 5.8891678730593, 5.91988479013194, 5.95703705471411, 5.9879222165115, 6.02476956696871, 6.0562832711056, 6.09066464763515, 6.11945135710302, 6.15224150983294, 6.18619542469553, 6.21906668800481, 6.25520901616116, 6.28817733087501, 6.31510657133144, 6.34857489227961, 6.38374387188953, 6.41487351955522, 6.44894533452268, 6.48258705449339, 6.51672318561308, 6.5492597619204, 6.58078810815883, 6.61202883805484, 6.64303547696969, 6.67920013469885, 6.71203996091858, 6.74970511770346, 6.78067987581109, 6.80946987517659, 6.84065200694156, 6.8739776715081, 6.91000528374422, 6.94329768980636, 6.97592508890411, 7.00795643577178, 7.03531429062994, 7.0727186557877, 7.10490966048338, 7.13951689512889, 7.17099466087468, 7.20780360703008, 7.23518758488332, 7.27141821077462, 7.30088393494746, 7.33559520145585, 7.3697473586269, 7.4058052188492, 7.43767504383989, 7.46704399484502, 7.50146517132372, 7.53249294285296, 7.56260034927672, 7.59822412848328, 7.63442853806061, 7.66816527586181, 7.69957908679883, 7.73089978759425, 7.7625131867015, 7.79672420829385, 7.82766682658215, 7.86220807940802, 7.89697212216558, 7.9263339944244, 7.9612796027185, 7.99316677778252, 8.03012672655467, 8.06147930238642, 8.0985563674335, 8.1245731561286, 8.16245933377271, 8.1928297133353, 8.22907645456185, 8.26045033196772, 8.29327729388658, 8.32221100569743, 8.35730518986317, 8.3898925761648, 8.4287712845196, 8.45932289473839, 8.49370466297118, 8.52083845311536, 8.55314923333571, 8.58714438062924, 8.61972918218492, 8.65020626116786, 8.68439584709904, 8.71904567167448, 8.75118069140941, 8.7828153876606, 8.81659518588072, 8.85041235080845, 8.88200686200441, 8.91631088450326, 8.94669469736071, 8.98260340549559, 9.01515363958816, 9.04766928844144, 9.08048815318307, 9.11551908353884, 9.14596913952395, 9.18613619247321, 9.21080864841652, 9.24549324137885, 9.27818173409693, 9.30972865143133, 9.34333006224595, 9.37378049882708, 9.40938843884553, 9.44041903312072, 9.47437169026377, 9.51017151286136, 9.54110618691993, 9.57376812851625, 9.60887630998439, 9.64233376884531, 9.67453303021312, 9.70727142250823, 9.74054817293834, 9.77305840874062, 9.80602656652056, 9.83876302895866, 9.87057652279354, 9.90106903499969, 9.939982323163, 9.9741784413198, 10.00371520357, 10.0355196862986, 10.0680672502415, 10.1005216920866, 10.136510175011, 10.1705003593003, 10.2027259320273, 10.2292878790002, 10.266141494439, 10.3002618030337, 10.3336852759173, 10.3649708485272, 10.403737793516, 10.4352076288416, 10.4686687112878, 10.4974821235412, 10.5313608444342, 10.5632687250463, 10.600263507463, 10.6296359038884, 10.6658828508408, 10.6942493497153, 10.7251709560106, 10.7623726231245, 10.7942872895625, 10.8279603484972, 10.8617319121286, 10.8977818113784, 10.9319767308185, 10.9618018722523, 10.9908947342538, 11.0232105847093, 11.0601998629084, 11.0931945872745, 11.1256870472074, 11.161017199122, 11.1931922953268, 11.226913412955, 11.2586308257396, 11.2889273254604, 11.3238000429017, 11.356464835918, 11.3934407867223, 11.426792800332, 11.460984592308, 11.489630081774, 11.5209965057654, 11.5552733986617, 11.5889013852967, 11.6230803242506, 11.6544329317311, 11.6879463861942, 11.7221812893431, 11.7519265226428, 11.7828984748207, 11.8183869834483, 11.8516582095254, 11.8877373466396, 11.9168792394663, 11.9488751375131, 11.9850580900123, 12.0154692530236, 12.0506556416447, 12.0849623173836, 12.1164720804581, 12.1512339197755, 12.1811414995244, 12.2112834273989, 12.2506409177278, 12.2827995636192, 12.3150200641974, 12.3444198425152, 12.3804240721211, 12.4114068174192, 12.4487335476492, 12.4788226321615, 12.512702891659, 12.5455083931406, 12.5832776212939, 12.6106814743237, 12.6467731704953, 12.6815886691362, 12.7118205995084, 12.7490332251543, 12.7782061291983, 12.8064612093795, 12.8406002215915, 12.8723390600588, 12.912579599602, 12.9427692124374, 12.9770521955276, 13.0036439288185, 13.040031707209, 13.0712828810522, 13.1058473225476, 13.140787975979, 13.1703706752573, 13.2044322224791, 13.2341300046639, 13.2684204004248, 13.3036858126593, 13.3386301526904, 13.3707730389246, 13.4021309538329, 13.4397893793408, 13.470784250392, 13.499476134129, 13.5357093237982, 13.5698671268893, 13.6011750962449, 13.6374692935124, 13.6685392146714, 13.7028296316718, 13.7313115638459, 13.7698916575217, 13.8015612900834, 13.831506905967, 13.8604417481234, 13.8948149116759, 13.9281397164005, 13.9641360168113, 13.9965909910587, 14.0306397973426, 14.0625990983902, 14.0938288206006, 14.1279733403169, 14.1601770996874, 14.1899035374603, 14.2268350750799, 14.2575212900904, 14.2898401211846, 14.3263000438805, 14.3579961242493, 14.3909093450655, 14.4227533184714, 14.4574538996111, 14.4912041927057, 14.5195869934107, 14.5525921933634, 14.585548900803, 14.619467027359, 14.6504796355594, 14.6864521218723, 14.7146696263005, 14.7559214237905, 14.7846325311109, 14.813234432684, 14.8439740231076, 14.877311850986, 14.9157562332138, 14.9426513785188, 14.9724288130682, 15.0085741602078, 15.0380326658908, 15.070607244273, 15.1006277691075, 15.1350263765497, 15.1670984841319, 15.1992367339223, 15.2289188333787, 15.262928064864, 15.2944233178196, 15.3249371035973, 15.3513777819162, 15.387428308117, 15.4144204034033, 15.4499804733894, 15.4775026546817, 15.5113708561867, 15.53963099182, 15.5678083414721, 15.600305607563, 15.6314698032757, 15.6647933303348, 15.6911601590058, 15.7216739822918, 15.7488478508454, 15.781902024031, 15.8030167758808, 15.8346032985842, 15.86837124336, 15.8905112646846, 15.9221092884042, 15.9504329415283, 15.9816308971478, 16.0044007948518, 16.0307084262849
])

# 定数
kBT = 4.1  # pN·nm
Lp = 50    # nm
Lc = 16.7  # μm


def eWLC_inverse(L, K):
    x = L / Lc
    def func(F):
        return x - (1 - 0.5 * np.sqrt(kBT / (F * Lp)) + F / K)
    sol = root_scalar(func, bracket=[0.01, 100], method='brentq')
    return sol.root if sol.converged else np.nan

def get_eWLC_force(L_array, K):
    return np.array([eWLC_inverse(L, K) for L in L_array])


def polyWLC(L):
    x = L / Lc
    coeffs = [-0.5164228, -2.737418, 16.07497]  # x^2, x^3, x^4
    poly = sum(c * x**(i + 2) for i, c in enumerate(coeffs))
    return (kBT / Lp) * (1/(4 * (1 - x)**2) - 0.25 + x + poly)

def compute_r2(y_true, y_pred):
    mask = np.isfinite(y_pred)
    return r2_score(y_true[mask], y_pred[mask])


F_eWLC_500 = get_eWLC_force(L_data, K=500)
F_eWLC_1000 = get_eWLC_force(L_data, K=1000)
F_eWLC_10000 = get_eWLC_force(L_data, K=10000)
F_polyWLC = polyWLC(L_data)


r2_500 = compute_r2(F_data, F_eWLC_500)
r2_1000 = compute_r2(F_data, F_eWLC_1000)
r2_10000 = compute_r2(F_data, F_eWLC_10000)
r2_poly = compute_r2(F_data, F_polyWLC)


plt.figure(figsize=(7, 7))
plt.scatter(L_data, F_data, s=10, color='gray', label='w/ SYTOX-Orange')

plt.plot(L_data, F_eWLC_500, 'red', label=f'eWLC (K=500), R²={r2_500:.3f}', linewidth=2)
plt.plot(L_data, F_eWLC_1000, 'green', label=f'eWLC (K=1000), R²={r2_1000:.3f}', linewidth=2)
plt.plot(L_data, F_eWLC_10000, 'orange', label=f'eWLC (K=10000), R²={r2_10000:.3f}', linewidth=2)
plt.plot(L_data, F_polyWLC, 'blue', label=f'polyWLC (4th deg.), R²={r2_poly:.3f}', linewidth=2)

plt.xlim(10, 16.5)
plt.ylim(-1, 18)
plt.xticks(fontsize=16)
plt.yticks(fontsize=16)
plt.xlabel("Extension (μm)", fontsize=20)
plt.ylabel("Force (pN)", fontsize=20)
plt.legend(fontsize=14)
plt.grid(True)
plt.tight_layout()
plt.savefig('eWLC.png', dpi=600)
plt.show()
